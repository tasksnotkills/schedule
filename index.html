<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Daily Target</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #2563eb;
            --border: #e2e8f0; --weekend: #f1f5f9; --today: rgba(37, 99, 235, 0.08);
            --sql-off: #ef4444; --sql-on: #10b981;
        }
        [data-theme="dark"] {
            --bg: #1a1a1a; --card: #242424; --text: #e2e8f0; --accent: #00d4ff;
            --border: #333333; --weekend: #1c1c1c; --today: rgba(0, 212, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            height: 100%; 
            height: 100dvh; /* Dynamic Viewport Height for Mobile */
            margin: 0; padding: 0; 
            overflow: hidden; 
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: var(--text);
            display: none; /* Hidden until passcode */
            flex-direction: column;
        }

        header {
            padding: calc(10px + env(safe-area-inset-top)) 15px 10px 15px; 
            background: var(--card); 
            border-bottom: 1px solid var(--border);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0;
            z-index: 100;
        }

        .hud-group { display: flex; gap: 12px; align-items: center; }
        .lvl-box { background: var(--bg); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .lvl-num { font-weight: 800; color: var(--accent); font-size: 0.9rem; }
        
        .sql-status { display: flex; align-items: center; gap: 5px; font-size: 9px; font-weight: 800; color: var(--sql-off); }
        .sql-status.online { color: var(--sql-on); }
        .dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; }

        .viewport { 
            flex-grow: 1; 
            overflow: auto; 
            scroll-behavior: smooth; 
            position: relative;
            background: var(--bg);
        }

        table { border-collapse: collapse; width: max-content; }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: center; width: 60px; }
        
        thead th { position: sticky; top: 0; background: var(--card); z-index: 30; }
        td:first-child, th:first-child { 
            position: sticky; left: 0; background: var(--card); z-index: 35; 
            text-align: left; width: 210px; border-right: 3px solid var(--accent); 
        }

        .active-row { background: rgba(37, 99, 235, 0.05) !important; }
        [data-theme="dark"] .active-row { background: rgba(0, 212, 255, 0.06) !important; }
        .weekend { background: var(--weekend) !important; }
        .today-col { background: var(--today) !important; }
        
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--accent); }
        .time-label { font-size: 0.6rem; opacity: 0.5; display: block; font-family: monospace; }
        .day-meta { font-size: 8px; display: block; opacity: 0.5; }

        .controls { display: flex; gap: 6px; align-items: center; }
        .icon-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
    </style>
</head>
<body id="appBody">

    <header>
        <div class="hud-group">
            <div class="lvl-box">
                <span class="lvl-num" id="monkLevel">1</span>
                <span style="font-size: 7px; display: block; opacity: 0.6; font-weight: 800;">LVL</span>
            </div>
            <div style="text-align: center;">
                <span id="streakVal" style="color:#ff4757; font-weight:900; font-size:1.1rem; display:block;">0</span>
                <span style="font-size:7px; opacity:0.6; font-weight:800; text-transform: uppercase;">Streak</span>
            </div>
        </div>

        <div class="controls">
            <div id="sqlStatus" class="sql-status"><div class="dot"></div> SQL</div>
            <select id="monthSelect" class="icon-btn"></select>
            <select id="yearSelect" class="icon-btn" style="width:65px"></select>
            <button onclick="document.getElementById('editor').style.display='flex'" class="icon-btn">‚öôÔ∏è</button>
            <button onclick="toggleTheme()" class="icon-btn">üåì</button>
        </div>
    </header>

    <div class="viewport" id="viewport">
        <table>
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- Modal remains the same -->
    <div class="modal" id="editor">
        <div class="modal-content">
            <h3 style="margin-top:0">Config Target</h3>
            <select id="taskSelect" style="width:100%; padding:10px; margin-bottom:10px;" onchange="loadEditorFields()"></select>
            <input type="text" id="editName" placeholder="Task Name" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="text" id="editRange" placeholder="Time Range" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="text" id="editStart" placeholder="Start Time" style="width:100%; padding:10px; margin-bottom:10px;">
            <button onclick="saveConfig()" style="width:100%; padding:10px; background:var(--accent); color:#fff; border:none; border-radius:6px; font-weight:bold;">SAVE</button>
            <button onclick="document.getElementById('editor').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; color:#888;">Cancel</button>
        </div>
    </div>

    <script>
        const MASKED_URL = "VTJGc2RHVmtYMS80ZnBQdnhxTXhUbVRMUVZYYVgxa0JOemlvNFZzckxaUUFyT0hBOWViMXJHRzNjR3lFYjF5WENjN2Fhc0RCUjJhMW0vejVyUG55Smc9PQ=="; 
        const MASKED_KEY = "VTJGc2RHVmtYMSs5eFlVVTdCRys0MzNFYVdOZTZwSnJ2M1VOOFVvTVhPWjFYdXU1YVJ4TDZFbjA2bVdkYlFYRFNZaXByVHBxTHpzYnlLaUY0dzVpMmc9PQ=="; 

        const defaultSchedule = [
            { id: 0, start_time: "07:20", time_range: "07:20‚Äì07:40", task_name: "Wake up + hygiene" },
            { id: 1, start_time: "07:40", time_range: "07:40‚Äì07:55", task_name: "Yoga / Light Exercise" },
            { id: 2, start_time: "07:55", time_range: "07:55‚Äì08:55", task_name: "Study Block 1" },
            { id: 3, start_time: "08:55", time_range: "08:55‚Äì09:05", task_name: "Short break / reset" },
            { id: 4, start_time: "09:05", time_range: "09:05‚Äì09:25", task_name: "Breakfast" },
            { id: 5, start_time: "09:25", time_range: "09:25‚Äì09:50", task_name: "Study Block 2" },
            { id: 6, start_time: "09:50", time_range: "09:50‚Äì10:05", task_name: "Short break / reset" },
            { id: 7, start_time: "10:05", time_range: "10:05‚Äì11:35", task_name: "Study Block 3" },
            { id: 8, start_time: "11:35", time_range: "11:35‚Äì11:55", task_name: "Short break / reset" },
            { id: 9, start_time: "11:55", time_range: "11:55‚Äì13:25", task_name: "Study Block 4" },
            { id: 10, start_time: "13:25", time_range: "13:25‚Äì13:40", task_name: "Short break / reset" },
            { id: 11, start_time: "13:40", time_range: "13:40‚Äì14:10", task_name: "Lunch" },
            { id: 12, start_time: "14:20", time_range: "14:20‚Äì15:40", task_name: "Study Block 5" },
            { id: 13, start_time: "15:40", time_range: "15:40‚Äì16:00", task_name: "Short break / reset" },
            { id: 14, start_time: "16:00", time_range: "16:00‚Äì17:30", task_name: "Study Block 6" },
            { id: 15, start_time: "18:30", time_range: "18:30‚Äì19:15", task_name: "Dinner / rest" },
            { id: 16, start_time: "19:15", time_range: "19:15‚Äì20:45", task_name: "Study Block 7" },
            { id: 17, start_time: "20:45", time_range: "20:45‚Äì21:00", task_name: "Short break / reset" },
            { id: 18, start_time: "21:00", time_range: "21:00‚Äì22:30", task_name: "Study (Revision)" },
            { id: 19, start_time: "22:30", time_range: "22:30‚Äì23:00", task_name: "Wind down" },
            { id: 20, start_time: "23:00", time_range: "23:00‚Äì00:00", task_name: "Reading" },
            { id: 21, start_time: "00:00", time_range: "00:00", task_name: "Sleep" }
        ];

        let _supabase, curYear = new Date().getFullYear(), curMonth = new Date().getMonth();
        let habits = {}, schedule = [...defaultSchedule];

        window.onload = async () => {
            const pass = prompt("Passcode:");
            try {
                const url = CryptoJS.AES.decrypt(atob(MASKED_URL), pass).toString(CryptoJS.enc.Utf8);
                const key = CryptoJS.AES.decrypt(atob(MASKED_KEY), pass).toString(CryptoJS.enc.Utf8);
                _supabase = supabase.createClient(url, key);
                document.getElementById('appBody').style.display = 'flex';
                initApp();
            } catch (e) { alert("Access Denied."); window.location.href = "about:blank"; }
        };

        async function initApp() {
            const ms = document.getElementById('monthSelect'), ys = document.getElementById('yearSelect');
            const mNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            mNames.forEach((m, i) => ms.add(new Option(m, i)));
            for(let y=2024; y<=2030; y++) ys.add(new Option(y, y));
            ms.value = curMonth; ys.value = curYear;
            ms.onchange = () => { curMonth = parseInt(ms.value); curYear = parseInt(ys.value); refresh(); };
            if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
            render(); refresh();
            setInterval(updateHUD, 60000);
        }

        async function refresh() {
            try {
                let [hRes, sRes] = await Promise.all([
                    _supabase.from('habit_data').select('*'),
                    _supabase.from('schedule_config').select('*').order('id', { ascending: true })
                ]);
                if (sRes.data && sRes.data.length > 0) schedule = sRes.data;
                else await _supabase.from('schedule_config').upsert(defaultSchedule);
                habits = {}; hRes.data?.forEach(i => habits[i.id] = i.status);
                document.getElementById('sqlStatus').classList.add('online');
                render(); updateStats(); updateHUD(true);
            } catch(e) { document.getElementById('sqlStatus').classList.remove('online'); }
        }

        function render() {
            const hRow = document.getElementById('headerRow'), tBody = document.getElementById('tableBody');
            const daysInM = new Date(curYear, curMonth + 1, 0).getDate(), now = new Date();
            hRow.innerHTML = '<th>TARGET LIST</th>'; tBody.innerHTML = '';
            const ts = document.getElementById('taskSelect'); ts.innerHTML = '';

            for(let d=1; d<=daysInM; d++) {
                const th = document.createElement('th');
                const date = new Date(curYear, curMonth, d);
                if(date.getDay() % 6 === 0) th.className = 'weekend';
                if(curYear === now.getFullYear() && curMonth === now.getMonth() && d === now.getDate()) { th.id = "todayMark"; th.className += " today-col"; }
                th.innerHTML = `${d}<span class="day-meta">${date.toLocaleDateString('en-US',{weekday:'short'})}</span>`;
                hRow.appendChild(th);
            }

            schedule.forEach(item => {
                ts.add(new Option(item.task_name, item.id));
                const tr = document.createElement('tr'); tr.id = `row-${item.id}`;
                const tdN = document.createElement('td');
                tdN.innerHTML = `<span class="time-label">${item.time_range}</span>${item.task_name}`;
                tr.appendChild(tdN);
                for(let d=1; d<=daysInM; d++) {
                    const td = document.createElement('td');
                    const key = `y${curYear}-m${curMonth}-t${item.id}-d${d}`;
                    if(new Date(curYear, curMonth, d).getDay() % 6 === 0) td.className = 'weekend';
                    if(curYear === now.getFullYear() && curMonth === now.getMonth() && d === now.getDate()) td.className += " today-col";
                    const cb = document.createElement('input');
                    cb.type = 'checkbox'; cb.checked = habits[key] || false;
                    cb.onchange = async (e) => {
                        habits[key] = e.target.checked;
                        if(e.target.checked) checkWin(d);
                        await _supabase.from('habit_data').upsert({ id: key, status: e.target.checked });
                        updateStats();
                    };
                    td.appendChild(cb); tr.appendChild(td);
                }
                tableBody.appendChild(tr);
            });
        }

        function updateHUD(isInit = false) {
            document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            let curr = schedule[0];
            schedule.forEach(s => { if(time >= s.start_time) curr = s; });
            if(curr) {
                const row = document.getElementById(`row-${curr.id}`);
                if(row) row.classList.add('active-row');
                if(isInit) setTimeout(() => { document.getElementById('todayMark')?.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 800);
            }
        }

        function updateStats() {
            const total = Object.values(habits).filter(v => v).length;
            document.getElementById('monkLevel').innerText = Math.floor(total / 50) + 1;
            let streak = 0; const nowDay = new Date().getDate();
            for(let d=1; d<=nowDay; d++) {
                let dDone = 0; schedule.forEach(s => { if(habits[`y${curYear}-m${curMonth}-t${s.id}-d${d}`]) dDone++; });
                if(schedule.length > 0 && (dDone / schedule.length) >= 0.8) streak++;
                else if (d < nowDay) streak = 0;
            }
            document.getElementById('streakVal').innerText = streak;
        }

        function checkWin(d) {
            let done = 0; schedule.forEach(s => { if(habits[`y${curYear}-m${curMonth}-t${s.id}-d${d}`]) done++; });
            if(done === schedule.length) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function toggleTheme() {
            const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }

        function loadEditorFields() {
            const s = schedule.find(x => x.id == document.getElementById('taskSelect').value);
            document.getElementById('editName').value = s.task_name;
            document.getElementById('editRange').value = s.time_range;
            document.getElementById('editStart').value = s.start_time;
        }

        async function saveConfig() {
            const id = document.getElementById('taskSelect').value;
            await _supabase.from('schedule_config').upsert({
                id: parseInt(id),
                task_name: document.getElementById('editName').value,
                time_range: document.getElementById('editRange').value,
                start_time: document.getElementById('editStart').value
            });
            document.getElementById('editor').style.display = 'none'; refresh();
        }
    </script>
</body>
</html>
